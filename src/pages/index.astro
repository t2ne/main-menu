---
import BaseHead from "../components/BaseHead.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { ALL_TAGS, APPS } from "../apps";
import { Image } from "astro:assets";

const EAGER_ICON_COUNT = 8;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <div class="bg" aria-hidden="true"></div>
    <div class="wrap">
      <header class="top">
        <div class="brand">
          <span class="mark" aria-hidden="true"></span>
          <span class="word">t2ne</span>
        </div>
        <h1 class="title">welcome back.</h1>
        <p class="subtitle">search and launch.</p>
      </header>

      <section class="controls" aria-label="Search and filters">
        <label class="sr-only" for="q">Search</label>
        <div class="field">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path
              fill="currentColor"
              d="M10 4a6 6 0 104.472 10.03l4.249 4.25 1.414-1.415-4.25-4.249A6 6 0 0010 4zm0 2a4 4 0 110 8 4 4 0 010-8z"
            ></path>
          </svg>
          <input
            id="q"
            name="q"
            type="search"
            placeholder="Search for apps"
            autocomplete="off"
          />
        </div>

        <label class="sr-only" for="tag">Filter by tag</label>
        <div class="field select">
          <select id="tag" name="tag">
            <option value="">All tags</option>
            {ALL_TAGS.map((t) => <option value={t}>{t}</option>)}
          </select>
        </div>

        <div class="meta" aria-live="polite">
          <span id="count"></span>
          <button
            class="refresh"
            id="refresh"
            type="button"
            aria-label="Refresh statuses"
            title="Refresh statuses"
          >
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                fill="currentColor"
                d="M17.65 6.35A7.95 7.95 0 0012 4a8 8 0 108 8h-2a6 6 0 11-6-6c1.66 0 3.14.69 4.22 1.78L14 10h6V4l-2.35 2.35z"
              ></path>
            </svg>
          </button>
        </div>
      </section>

      <main class="grid" id="grid" aria-label="Apps">
        {
          APPS.map((app, i) => (
            <a
              class="tile"
              href={app.href}
              target="_blank"
              rel="noopener noreferrer"
              data-name={app.name.toLowerCase()}
              data-tags={app.tags.join(",")}
            >
              <div class="tile-inner">
                <div class="badge-row">
                  {app.tags[0] && <span class="pill">{app.tags[0]}</span>}
                  <div
                    class="status"
                    data-status="unknown"
                    role="status"
                    aria-label="Status: unknown"
                  >
                    <span class="dot" aria-hidden="true" />
                    <span class="text">…</span>
                  </div>
                </div>
                <div class="logo" aria-hidden="true">
                  <Image
                    src={app.iconUrl}
                    width={44}
                    height={44}
                    alt=""
                    loading={i < EAGER_ICON_COUNT ? "eager" : "lazy"}
                    decoding="async"
                    fetchpriority={i < EAGER_ICON_COUNT ? "high" : "auto"}
                  />
                </div>
                <div class="name">{app.name}</div>
              </div>
            </a>
          ))
        }
      </main>

      <p class="empty" id="empty" hidden>No matches.</p>
    </div>

    <footer class="footer">
      <a
        href="https://github.com/t2ne"
        target="_blank"
        rel="noopener noreferrer"
        class="footer-link">github</a
      > / <a
        href="https://no-tone.com"
        target="_blank"
        rel="noopener noreferrer"
        class="footer-link">main</a
      >
    </footer>

    <script
      define:vars={{
        tailnetProbeUrl: import.meta.env.PUBLIC_TAILNET_PROBE_URL ?? "",
      }}
    >
      const root = document.documentElement;
      const q = document.getElementById("q");
      const tag = document.getElementById("tag");
      const tiles = Array.from(document.querySelectorAll("a.tile[data-name]"));
      const count = document.getElementById("count");
      const empty = document.getElementById("empty");

      function applyFilter() {
        const query = (q?.value ?? "").trim().toLowerCase();
        const selected = (tag?.value ?? "").trim();

        let visible = 0;
        for (const el of tiles) {
          const show =
            (!query || (el.dataset.name ?? "").includes(query)) &&
            (!selected || (el.dataset.tags ?? "").includes(selected));
          el.hidden = !show;
          if (show) visible++;
        }

        if (count) count.textContent = `${visible} / ${tiles.length}`;
        if (empty) empty.hidden = visible !== 0;
      }

      q?.addEventListener("input", applyFilter);
      tag?.addEventListener("change", applyFilter);
      applyFilter();

      const reduceMotion = window.matchMedia(
        "(prefers-reduced-motion: reduce)",
      ).matches;
      if (!reduceMotion) {
        function updateTileShine(clientX, clientY) {
          const radius = 220;
          for (const el of tiles) {
            if (el.hasAttribute("hidden")) continue;

            const rect = el.getBoundingClientRect();
            const corners = [
              { x: rect.left, y: rect.top, sx: 0, sy: 0 },
              { x: rect.right, y: rect.top, sx: 100, sy: 0 },
              { x: rect.left, y: rect.bottom, sx: 0, sy: 100 },
              { x: rect.right, y: rect.bottom, sx: 100, sy: 100 },
            ];

            let best = corners[0];
            let bestD = Infinity;
            for (const c of corners) {
              const d = Math.hypot(clientX - c.x, clientY - c.y);
              if (d < bestD) {
                bestD = d;
                best = c;
              }
            }

            const intensity = Math.max(0, 1 - bestD / radius);
            el.style.setProperty("--s", intensity.toFixed(3));
            el.style.setProperty("--sx", `${best.sx}%`);
            el.style.setProperty("--sy", `${best.sy}%`);
          }
        }

        window.addEventListener(
          "pointermove",
          (e) => {
            root.style.setProperty("--mx", `${e.clientX}px`);
            root.style.setProperty("--my", `${e.clientY}px`);
            updateTileShine(e.clientX, e.clientY);
          },
          { passive: true },
        );

        function resetTileShine() {
          for (const el of tiles) el.style.setProperty("--s", "0");
        }

        window.addEventListener("blur", resetTileShine);
        document.addEventListener("mouseleave", resetTileShine);
      }

      window.addEventListener("keydown", (e) => {
        if (e.key === "/" && document.activeElement !== q) {
          e.preventDefault();
          q?.focus();
        }
      });

      const STATUS_REFRESH_MS = 90_000;
      const STATUS_TIMEOUT_MS = 2500;
      const CLIENT_TIMEOUT_MS = 1200;

      // Tailnet probe host(s).
      // `.env`: `PUBLIC_TAILNET_PROBE_URL=desktopHost,mobileHost` (mobile optional)
      // Note: `PUBLIC_*` env vars are embedded into client JS.
      const [PROBE_DESKTOP, PROBE_MOBILE] = (tailnetProbeUrl || "")
        .split(",")
        .map((s) => s.trim());

      const isMobile =
        window.matchMedia?.("(pointer: coarse)")?.matches ||
        window.matchMedia?.("(max-width: 680px)")?.matches;

      const TAILNET_PROBE_URL = isMobile
        ? PROBE_MOBILE || PROBE_DESKTOP
        : PROBE_DESKTOP || PROBE_MOBILE;

      function setTileStatus(tile, status) {
        const b = tile.querySelector(".status");
        if (!b) return;
        b.dataset.status = status;
        b.setAttribute("aria-label", `Status: ${status}`);
        const t = b.querySelector(".text");
        if (t)
          t.textContent =
            status === "checking" ? "…" : status === "unknown" ? "?" : status;
      }

      function ping(tile, self) {
        const c = new AbortController();
        const t = setTimeout(
          () => c.abort(),
          self ? CLIENT_TIMEOUT_MS : STATUS_TIMEOUT_MS,
        );
        const u = new URL(tile.href);
        const p = u.hostname === "pass.no-tone.com" ? "/favicon.ico" : "/";
        return fetch(new URL(p, u), {
          mode: "no-cors",
          cache: "no-store",
          signal: c.signal,
        })
          .then(
            () => true,
            () => false,
          )
          .finally(() => clearTimeout(t));
      }

      function pingProbe(rawUrl) {
        const url = (rawUrl || "").trim();
        if (!url) return Promise.resolve(false);

        const hasScheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(url);
        // If it's not an actual HTTP(S) URL, we can't "ping" it from a browser.
        // (ICMP ping isn't available in JS, and trying to fetch a MagicDNS-only
        // name can also fail if the browser uses Secure DNS / DoH.)
        if (!hasScheme) return Promise.resolve(false);
        const normalized = url;

        const c = new AbortController();
        const t = setTimeout(() => c.abort(), CLIENT_TIMEOUT_MS);
        return fetch(normalized, {
          mode: "no-cors",
          cache: "no-store",
          signal: c.signal,
        })
          .then(
            () => true,
            () => false,
          )
          .finally(() => clearTimeout(t));
      }

      function hasTailnetIP() {
        return new Promise((resolve) => {
          try {
            const pc = new RTCPeerConnection({ iceServers: [] });
            const done = (v) => {
              try {
                pc.onicecandidate = null;
                pc.close();
              } catch {}
              resolve(v);
            };
            const timer = setTimeout(() => done(false), 700);

            const isTailnet = (ip) => {
              if (!ip) return false;
              if (ip.startsWith("fd7a:115c:a1e0")) return true; // Tailscale ULA
              const m = ip.match(/^(\d{1,3})\.(\d{1,3})\./);
              if (!m) return false;
              const a = +m[1],
                b = +m[2];
              return a === 100 && b >= 64 && b <= 127; // 100.64.0.0/10
            };

            pc.createDataChannel("x");
            pc.onicecandidate = (e) => {
              const c = e.candidate?.candidate;
              if (!c) return;
              const ip = c.match(/(\d{1,3}(?:\.\d{1,3}){3})/)?.[1];
              const ip6 = c.match(/([0-9a-fA-F:]{2,})/)?.[1];
              if (isTailnet(ip) || isTailnet(ip6)) {
                clearTimeout(timer);
                done(true);
              }
            };

            pc.createOffer()
              .then((o) => pc.setLocalDescription(o))
              .catch(() => {
                clearTimeout(timer);
                done(false);
              });
          } catch {
            resolve(false);
          }
        });
      }

      async function checkStatuses() {
        // Prefer the local check first to avoid noisy failed network requests.
        const onTailnet =
          (await hasTailnetIP()) || (await pingProbe(TAILNET_PROBE_URL));

        await Promise.all(
          tiles.map(async (tile) => {
            setTileStatus(tile, "checking");
            const self = (tile.dataset.tags ?? "").includes("Self-Hosted");
            const ok = await ping(tile, self);
            if (!self) return setTileStatus(tile, ok ? "up" : "down");
            setTileStatus(tile, ok ? "up" : onTailnet ? "down" : "vpn");
          }),
        );
      }

      // Initial status check + periodic refresh.
      let statusRunning = false;
      const runStatusCheck = () =>
        !statusRunning &&
        ((statusRunning = true),
        checkStatuses().finally(() => (statusRunning = false)));

      const refreshBtn = document.getElementById("refresh");
      refreshBtn?.addEventListener("click", () => {
        // retrigger the animation even on rapid clicks
        refreshBtn.classList.remove("spinning");
        void refreshBtn.offsetWidth;
        refreshBtn.classList.add("spinning");
        runStatusCheck();
      });

      refreshBtn?.addEventListener("animationend", () =>
        refreshBtn.classList.remove("spinning"),
      );

      runStatusCheck();
      window.setInterval(runStatusCheck, STATUS_REFRESH_MS);
    </script>
  </body>
</html>
